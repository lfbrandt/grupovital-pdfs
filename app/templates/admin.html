{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<main class="admin-page">
  <header class="admin-toolbar">
    <h1>Dashboard</h1>
    <div class="admin-actions">
      <div class="filters">
        <label class="sr-only" for="range">Período</label>
        <select id="range" class="adm-select" aria-label="Período">
          <option value="15m">Últimos 15 min</option>
          <option value="1h">Última 1 hora</option>
          <option value="24h">Últimas 24 horas</option>
        </select>
        <label class="sr-only" for="autorf">Auto-refresh</label>
        <select id="autorf" class="adm-select" aria-label="Auto-refresh">
          <option value="0">Auto-refresh: Off</option>
          <option value="5000">Auto-refresh: 5s</option>
          <option value="30000">Auto-refresh: 30s</option>
          <option value="60000">Auto-refresh: 60s</option>
        </select>
      </div>
      <input id="adm-token" type="password" class="adm-input" placeholder="Cole o token do admin" aria-label="Token do admin">
      <button id="btn-reload" class="btn-primary">Recarregar</button>
      <span id="msg" class="adm-msg" aria-live="polite"></span>
    </div>
  </header>

  <!-- RESUMO -->
  <section class="admin-section">
    <div class="section-title">
      <h2>Resumo</h2>
      <div class="badges">
        <span class="badge" id="badge-version">v-</span>
        <span class="badge" id="badge-env">env-</span>
        <span class="badge" id="badge-build">build-</span>
      </div>
    </div>

    <div class="stat-grid" id="summary-cards"></div>

    <div class="chart-card" aria-labelledby="chart-title" role="group">
      <div class="chart-header">
        <h3 id="chart-title">Taxa de sucesso (2xx) por total de requisições</h3>
        <div class="chart-hint" title="Cálculo: sucesso = respostas 2xx ÷ (2xx + 4xx + 5xx). As faixas exibem o volume relativo por categoria de status.">?</div>
      </div>

      <figure class="status-visual" aria-describedby="chart-caption">
        <div class="status-donut" id="status-donut" aria-label="Distribuição por status HTTP" role="img"></div>
        <figcaption id="chart-caption" class="chart-caption">
          <p id="chart-narrative">—</p>
          <ul class="legend" id="status-legend"></ul>
        </figcaption>
      </figure>

      <div class="chart-footer">
        <div class="chip ok" id="chip-success">Sucesso</div>
        <div class="chip warn" id="chip-4xx">4xx</div>
        <div class="chip err" id="chip-5xx">5xx</div>
        <div class="spacer"></div>
        <div class="chip neutral" id="chip-total">Total</div>
      </div>
      <div id="chart-tooltip" class="chart-tooltip" role="status" aria-live="polite"></div>
    </div>
  </section>

  <!-- TENDÊNCIA -->
  <section class="admin-section" id="trend-section" hidden>
    <div class="section-title"><h2>Tendência</h2></div>
    <div class="sparkline-card">
      <div class="sparkline-head">
        <span>Requisições por minuto</span>
        <span class="sparkline-legend" id="spark-legend">—</span>
      </div>
      <div id="req-sparkline" class="sparkline" role="img" aria-label="Requisições por minuto"></div>
    </div>
  </section>

  <!-- FERRAMENTAS -->
  <section class="admin-section">
    <div class="section-title"><h2>Ferramentas</h2></div>
    <div class="tools-grid" id="tools-grid"></div>
  </section>

  <!-- FALHAS RECENTES -->
  <section class="admin-section" id="errors-section" hidden>
    <div class="section-title"><h2>Falhas recentes</h2></div>
    <div class="errors-card">
      <table class="errors-table" id="errors-table" aria-label="Falhas recentes">
        <thead><tr><th>Hora</th><th>Rota</th><th>Status</th><th>Mensagem</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- LOGS DA APLICAÇÃO -->
  <section class="admin-section">
    <div class="section-title">
      <h2>Logs</h2>
      <div class="badges" style="gap:.35rem;flex-wrap:wrap">
        <select id="logs-level" class="adm-select" aria-label="Nível de log">
          <option value="">Todos</option>
          <option value="ERROR">ERROR</option>
          <option value="WARNING">WARNING</option>
          <option value="INFO">INFO</option>
          <option value="DEBUG">DEBUG</option>
          <option value="CRITICAL">CRITICAL</option>
        </select>
        <select id="logs-tail" class="adm-select" aria-label="Qtd de linhas">
          <option value="200">200 linhas</option>
          <option value="400" selected>400 linhas</option>
          <option value="800">800 linhas</option>
          <option value="1600">1600 linhas</option>
        </select>
        <button id="logs-refresh" class="btn-primary">Atualizar</button>

        <!-- Enviar linha de log (novo) -->
        <select id="logs-level-add" class="adm-select" aria-label="Nível para enviar">
          <option>INFO</option>
          <option>WARNING</option>
          <option>ERROR</option>
          <option>DEBUG</option>
          <option>CRITICAL</option>
        </select>
        <input id="logs-msg" class="adm-input" placeholder="Escreva uma linha de log (Ctrl/Cmd+Enter)">
        <button id="logs-send" class="btn-primary">Gerar log</button>
      </div>
    </div>
    <div class="adm-msg" id="logs-meta">—</div>
    <div id="logs-container" class="logs-box" aria-live="polite" aria-busy="false"></div>
  </section>
</main>

<!-- Modal de Logs por ferramenta -->
<div id="log-modal" hidden>
  <div id="log-panel">
    <div id="log-head">
      <span id="log-title">Logs</span>
      <button id="log-close" aria-label="Fechar">×</button>
    </div>
    <pre id="log-body">Carregando…</pre>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='js/admin.js') }}" defer></script>
{% endblock %}