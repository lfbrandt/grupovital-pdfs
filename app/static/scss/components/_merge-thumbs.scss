/* ==========================================================================
   COMPONENTES — Thumbs do /merge no grid único (mesmo look do split)
   Robusto: usa fallbacks próprios e NÃO depende de pages/_merge.scss.
   Mantém “contain” real (sem crop) e altura fixa via --card-h.
   ========================================================================== */

/* ---------- Paleta por origem (A..Z) ------------------------------------- */
$src-colors: (
  "A": #00995d, "B": #3213f9, "C": #0032bc, "D": #dd0000, "E": #ffffff, "F": #8e5c2e,
  "G": #16a085, "H": #2c3e50, "I": #c0392b, "J": #3f51b5, "K": #8bc34a, "L": #00bcd4,
  "M": #e67e22, "N": #9b59b6, "O": #f39c12, "P": #34495e, "Q": #1abc9c, "R": #e74c3c,
  "S": #27ae60, "T": #2980b9, "U": #d35400, "V": #7f8c8d, "W": #2ecc71, "X": #3498db,
  "Y": #f1c40f, "Z": #e84393
);

@each $letter, $color in $src-colors {
  #preview-merge .page-wrapper.page-thumb[data-source="#{$letter}"] {
    .page-badge, .source-badge {
      background: #{$color};
      color: #fff;
      text-shadow: 0 1px 1px rgba(0,0,0,.25);
    }
  }
}

/* ===================== Grid raiz + tokens ================================ */
#preview-merge {
  /* Se o projeto setar --gv-thumb-w/gap/card-h, usamos; senão, fallback local */
  --thumb-w: var(--gv-thumb-w, 200px);
  --thumb-gap: var(--gv-thumb-gap, 12px);
  --a4-ratio: 1.41421356; /* √2 */
  --card-h: var(--gv-card-h, calc(var(--thumb-w) * var(--a4-ratio)));

  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(var(--thumb-w), var(--thumb-w)));
  grid-auto-rows: var(--card-h);
  gap: var(--thumb-gap);
  justify-content: start;
  align-content: start;
  grid-auto-flow: row dense;
}

/* ===================== Card base ======================================== */
#preview-merge .page-wrapper.page-thumb {
  position: relative;
  inline-size: var(--thumb-w);
  block-size: var(--card-h);                 /* garante altura mesmo sem pages/_merge.scss */
  background: var(--surface, #fff);
  border: 1px solid var(--glass-border, rgba(0,0,0,.08));
  border-radius: .8rem;
  box-shadow: 0 1px 6px rgba(0,0,0,.05);
  padding: 0;                                /* não reduzir área útil */
  outline: none;
  user-select: none;
  overflow: hidden;
  z-index: 0;
  contain: layout paint;                      /* isola layout/pintura */

  transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;

  &:hover { transform: translateY(-1px); box-shadow: 0 3px 12px rgba(0,0,0,.08); }
  &:focus { outline: 2px solid var(--primary, #00995d); outline-offset: 2px; }

  &.is-dragging   { opacity: .85; }
  &.is-drop-target{ box-shadow: inset 0 0 0 2px var(--primary, #00995d); border-color: var(--primary, #00995d); }
  &.selected      {
    border-color: var(--primary, #00995d);
    box-shadow: 0 0 0 2px color-mix(in oklab, var(--primary, #00995d), white 35%);
  }
}

/* ===================== Frame e mídia ==================================== */
/* Frame ocupa 100% do card com aspecto A4 (retrato) */
#preview-merge .page-wrapper.page-thumb .thumb-frame {
  position: absolute;
  inset: 0;
  display: block;
  inline-size: 100%;
  block-size: 100%;
  border-radius: .6rem;
  overflow: hidden;
  background: var(--surface-2, #fff);
  contain: paint;
}

/* Wrapper da mídia centralizado; o JS acrescenta rotate()+scale() */
#preview-merge .page-wrapper.page-thumb .thumb-media {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);          /* JS adiciona rotate/scale */
  transform-origin: 50% 50%;
  backface-visibility: hidden;
  transition: transform .12s ease, filter .12s ease;
  image-rendering: auto;
}

/* Resets — não usamos canvas/img com classe .thumb-media; ficam DENTRO do frame */
#preview-merge .page-wrapper.page-thumb .thumb-frame > canvas,
#preview-merge .page-wrapper.page-thumb .thumb-frame > img {
  width: 100%;
  height: auto;                               /* evita crop/esticar */
  max-inline-size: none;
  max-block-size: none;
  display: block;
  margin: 0;
  border: 0;
  background: #fff;
}

/* Micro anti-serrilhado quando rotacionado 90/270 (Chrome) */
@supports (filter: blur(0.001px)) {
  #preview-merge .thumb-media[style*="rotate(90deg)"],
  #preview-merge .thumb-media[style*="rotate(270deg)"] {
    filter: blur(0.001px);
  }
}

/* ===================== Badges e controles =============================== */
#preview-merge .page-wrapper.page-thumb .page-badge {
  position: absolute;
  inset: .35rem .35rem auto .35rem;
  background: var(--primary, #00995d);
  color: #fff;
  font-weight: 700;
  font-size: .78rem;
  line-height: 1;
  border-radius: .4rem;
  padding: .25rem .5rem;
  z-index: 3;
  pointer-events: none;
  box-shadow: 0 1px 3px rgba(0,0,0,.15);
}

#preview-merge .page-wrapper.page-thumb .source-badge {
  position: absolute;
  inset: auto auto .45rem .55rem;
  background: var(--primary, #00995d);
  color: #fff;
  font-weight: 800;
  font-size: .75rem;
  border-radius: .45rem;
  padding: .12rem .4rem;
  z-index: 3;
  pointer-events: none;
  box-shadow: 0 1px 3px rgba(0,0,0,.2);
}

#preview-merge .page-wrapper.page-thumb .file-controls {
  position: absolute;
  top: .3rem;
  right: .35rem;
  display: flex;
  gap: .25rem;
  z-index: 4;

  button {
    appearance: none;
    border: 1px solid rgba(0,0,0,.35);
    background: rgba(0,0,0,.75);
    color: #fff;
    inline-size: 28px;
    block-size: 28px;
    border-radius: .5rem;
    font-size: 16px;
    line-height: 1;
    display: grid;
    place-items: center;
    cursor: pointer;
    transition: transform .08s ease, background .12s ease, opacity .12s ease;

    &:hover { background: rgba(0,0,0,.82); }
    &:active { transform: translateY(1px); }
  }
}

/* Efeito de feedback rápido (quando necessário via JS) */
#preview-merge .page-wrapper .jump-blink { animation: blink .6s ease 1; }
@keyframes blink {
  from { box-shadow: 0 0 0 3px var(--primary, #00995d); }
  to   { box-shadow: 0 0 0 0 transparent; }
}